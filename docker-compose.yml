version: '3.8' 

# ============================================================================ 
# Energy Demand Forecasting - Docker Compose Configuration
# ============================================================================ 
# Usage: docker-compose up -d

services:
  # PostgreSQL with TimescaleDB extension
  timescaledb:
    image: timescale/timescaledb:latest-pg14
    container_name: energy_forecasting_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: energy_forecasting
      POSTGRES_USER: ml_app_user
      POSTGRES_PASSWORD: ${DB_PASSWORD:-devpassword123}
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "5432:5432"
    volumes:
      - timescale_data:/var/lib/postgresql/data
      - ./sql/schemas:/docker-entrypoint-initdb.d:ro
    networks:
      - energy_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ml_app_user -d energy_forecasting"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis for caching and message queue
  redis:
    image: redis:7-alpine
    container_name: energy_forecasting_redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-redispassword123}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - energy_net
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

# Named volumes for data persistence
volumes:
  timescale_data:
    name: energy_forecasting_timescale_data
  redis_data:
    name: energy_forecasting_redis_data

# Network for service communication
networks:
  energy_net:
    name: energy_forecasting_network
    driver: bridge
